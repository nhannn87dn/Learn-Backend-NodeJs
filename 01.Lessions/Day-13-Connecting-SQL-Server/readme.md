# Using MongoDB and SQL Server

Trong b√†i h·ªçc n√†y ch√∫ng ta t√¨m hi·ªÉu c√°c v·∫•n ƒë·ªÅ sau:

- Connecting to SQL Server 
- PUT and PATH



## üíõ Connecting to SQL Server 

H·ªçc c√°ch k·∫øt n·ªëi v·ªõi Database ƒë·ªÉ l·∫•y d·ªØ li·ªáu sau ƒë√≥ tr·∫£ v·ªÅ cho Clients

### üî∂ K·∫øt n·ªëi v·ªõi SQL Server thu·∫ßn

Doc: <https://github.com/tediousjs/node-mssql>
#### üåªC√†i ƒë·∫∑t

Th∆∞ vi·ªán SQL Server cho NodeJS

```bash
yarn add mssql
```

#### üåªT·∫°o m·ªôt Database trong SQL Server

T·∫°o table Users/Employees 

```SQL
CREATE DATABASE AptechTEST;
GO
USE AptechTEST;
GO
CREATE TABLE Users (
  id INT PRIMARY KEY IDENTITY,
  firstName NVARCHAR(20) NOT NULL,
  lastName NVARCHAR(20) NOT NULL,
  numberPhone NVARCHAR(120) NOT NULL,
  email NVARCHAR(50) NOT NULL,
  address NVARCHAR(50) NULL,
  birthday DATE NULL,
  password NVARCHAR(255) NOT NULL
);
GO

INSERT INTO Users (firstName, lastName, numberPhone, email, address, birthday, password)
VALUES
  ('John', 'Doe', '1234567890', 'john.doe@example.com', '123 Main St', '1990-01-01', 'password1'),
  ('Jane', 'Smith', '0987654321', 'jane.smith@example.com', '456 Elm St', '1995-02-15', 'password2'),
  ('Michael', 'Johnson', '9876543210', 'michael.johnson@example.com', '789 Oak Ave', '1985-07-10', 'password3'),
  ('Emily', 'Williams', '0123456789', 'emily.williams@example.com', '321 Pine Blvd', '1992-12-05', 'password4'),
  ('David', 'Brown', '5678901234', 'david.brown@example.com', '654 Cedar Ln', '1998-09-20', 'password5');
GO
```

#### üåª Setup k·∫øt n·ªëi

Trong folder config t·∫°o file dbPool.js t·∫°o k·∫øt n·ªëi v√† t√°i s·ª≠ d·ª•ng k·∫øt n·ªëi r√£nh

```js
const sql = require('mssql');

// C·∫•u h√¨nh k·∫øt n·ªëi
const dbConfig = {
  user: 'nhan',
  password: '123456789',
  server: 'NHAN2', // Thay th·∫ø b·∫±ng ƒë·ªãa ch·ªâ server c·ªßa b·∫°n
  database: 'AptechTEST',
  options: {
    encrypt: false, // T√πy ch·ªçn b·∫£o m·∫≠t (tu·ª≥ theo c·∫•u h√¨nh c·ªßa SQL Server)
  },
  pool: {
    max: 10, // S·ªë l∆∞·ª£ng k·∫øt n·ªëi t·ªëi ƒëa trong pool
    min: 0, // S·ªë l∆∞·ª£ng k·∫øt n·ªëi t·ªëi thi·ªÉu trong pool
    idleTimeoutMillis: 30000, // Th·ªùi gian t·ªëi ƒëa ƒë·ªÉ k·∫øt n·ªëi trong pool ·ªü tr·∫°ng th√°i ch·ªù
  },
};

// T·∫°o global pool
const pool = new sql.ConnectionPool(dbConfig);
const poolConnect = pool.connect();

// X·ª≠ l√Ω l·ªói k·∫øt n·ªëi
poolConnect.catch(err => {
  console.error('Error connecting to SQL Server:', err);
});

// ƒê·∫£m b·∫£o r·∫±ng pool ƒë√£ k·∫øt n·ªëi tr∆∞·ªõc khi xu·∫•t module
poolConnect.then(() => {
  console.log('Connected to SQL Server');
}).catch(err => {
  console.error('Error connecting to SQL Server:', err);
});

module.exports = {
    pool,
    sql
};

```

#### üåª S·ª≠ d·ª•ng k·∫øt n·ªëi

Trong c√°c routes b·∫°n d√πng n√≥ nh∆∞ sau:

```js
const {pool,sql} = require('../configs/dbPool');

// Get all users
// localhost:8686/api/v1/users
router.get('/users', async (req, res,next) => {
  try {
    /**
     * S·ª≠ d·ª•ng c√∫ ph√°p SQL server thu·∫ßn t√πy ·ªü ƒë√¢y
     */
    const result = await pool.request().query('SELECT * FROM users');
    
    res.status(200).json({
      codeStatus: 200,
      message: 'Success',
      data: result.recordset
    });
    
  } catch (err) {
    next(err);
  }

});
```


T·∫°o ƒë·∫ßy ƒë·ªß CURD API v·ªõi Users/Employees v·ªõi SQL Server

- GET : api/v1/users
- GET : api/v1/users/:id
- POST : api/v1/users/:id
- PUT : api/v1/users/:id
- DELETE: api/v1/users/:id


####  üåª Data Types

Xem: https://github.com/tediousjs/node-mssql#data-types


## üíõ PUT and PATH

Trong RESTful API, PUT v√† PATCH l√† hai ph∆∞∆°ng th·ª©c HTTP kh√°c nhau ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ c·∫≠p nh·∫≠t t√†i nguy√™n. 

C√≥ r·∫•t nhi·ªÅu tranh lu·∫≠n n√™n d√πng PUT hay PATH

|                    | PUT | PATCH |
|--------------------|-----|-------|
| Partial Updates    | ‚ùå   | ‚úîÔ∏è     |
| Bandwidth          | ‚¨ÜÔ∏è   | ‚¨áÔ∏è     |
| Creates a resource | ‚úîÔ∏è   | ‚ùå     |
| Idempotent         | ‚úîÔ∏è   | ‚ùå     |
| Safe               | ‚ùå   | ‚ùå     |

Tham kh·∫£o: <https://josipmisko.com/posts/patch-vs-put-rest-api>


D∆∞·ªõi ƒë√¢y l√† s·ª± kh√°c bi·ªát gi·ªØa PUT v√† PATCH:

1. PUT (C·∫≠p nh·∫≠t to√†n b·ªô t√†i nguy√™n):
   - Ph∆∞∆°ng th·ª©c PUT ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ c·∫≠p nh·∫≠t to√†n b·ªô t√†i nguy√™n ho·∫∑c t·∫°o m·ªõi n·∫øu t√†i nguy√™n ch∆∞a t·ªìn t·∫°i.
   - Khi s·ª≠ d·ª•ng PUT, b·∫°n g·ª≠i m·ªôt y√™u c·∫ßu c·∫≠p nh·∫≠t ho√†n to√†n v√† ghi ƒë√® l√™n t√†i nguy√™n hi·ªán c√≥. ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† t·∫•t c·∫£ c√°c tr∆∞·ªùng d·ªØ li·ªáu c·ªßa t√†i nguy√™n s·∫Ω ƒë∆∞·ª£c thay th·∫ø b·∫±ng d·ªØ li·ªáu m·ªõi ƒë∆∞·ª£c g·ª≠i.
   - N·∫øu b·∫°n ch·ªâ g·ª≠i m·ªôt ph·∫ßn c·ªßa t√†i nguy√™n trong y√™u c·∫ßu PUT, nh·ªØng ph·∫ßn kh√¥ng ƒë∆∞·ª£c g·ª≠i s·∫Ω b·ªã x√≥a ho·∫∑c tr·ªü th√†nh gi√° tr·ªã m·∫∑c ƒë·ªãnh (n·∫øu c√≥) tu·ª≥ thu·ªôc v√†o ·ª©ng d·ª•ng.

V√≠ d·ª• c√≥ m·ªôt record v·ªõi th√¥ng tin sau:

```json

{
    "id": 1,
    "name": "John Smith",
    "age": 25,
    "skill": "Java, PHP"
}

```
B√¢y gi·ªù mu·ªën b·ªï sung th√™m skill cho id : 1

Request: PUT /users/1

Request payload:

```json
"skill": "Java, PHP, Python, JavaScript"
```

B√¢y gi·ªù m√¨nh ki·ªÉm tra l·∫°i xem th√¥ng tin John ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ch∆∞a.

Request: GET /user/1
Response:

```json
"skill": "Java, PHP, Python, JavaScript"
```

C·∫≠p nh·∫≠t r·ªìi, nh∆∞ng tr∆∞·ªùng name, v√† age ƒë√£ bi·∫øn m·∫•t

2. PATCH (C·∫≠p nh·∫≠t m·ªôt ph·∫ßn t√†i nguy√™n):
   - Ph∆∞∆°ng th·ª©c PATCH ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ c·∫≠p nh·∫≠t m·ªôt ph·∫ßn c·ªßa t√†i nguy√™n.
   - Khi s·ª≠ d·ª•ng PATCH, b·∫°n ch·ªâ c·∫ßn g·ª≠i c√°c tr∆∞·ªùng d·ªØ li·ªáu c·∫ßn c·∫≠p nh·∫≠t trong y√™u c·∫ßu. C√°c tr∆∞·ªùng d·ªØ li·ªáu kh√°c c·ªßa t√†i nguy√™n s·∫Ω kh√¥ng b·ªã thay ƒë·ªïi.
   - Ph∆∞∆°ng th·ª©c PATCH cho ph√©p b·∫°n th·ª±c hi·ªán c√°c thay ƒë·ªïi nh·ªè m√† kh√¥ng c·∫ßn g·ª≠i l·∫°i to√†n b·ªô t√†i nguy√™n. ƒêi·ªÅu n√†y h·ªØu √≠ch khi b·∫°n ch·ªâ mu·ªën c·∫≠p nh·∫≠t m·ªôt s·ªë tr∆∞·ªùng d·ªØ li·ªáu m√† kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn c√°c tr∆∞·ªùng kh√°c.


C≈©ng v·ªõi v√≠ d·ª• tr√™n th·ª±c hi·ªán v·ªõi PATH th√¨ sau khi c·∫≠p nh·∫≠t b·∫°n nh·∫≠t ƒë∆∞·ª£c response

```json

{
    "id": 1,
    "name": "John Smith",
    "age": 25,
    "skill": "Java, PHP, Python, JavaScript"
}

```

==> PATCH ch·ªâ c·∫≠p nh·∫≠t nh·ªØng field ƒë∆∞·ª£c y√™u c·∫ßu thay v√¨ c·∫≠p nh·∫≠t to√†n b·ªô.



### üî∂ K·∫øt n·ªëi v·ªõi SQL Server v·ªõi ORM Tools

#### üåª ORM l√† g√¨ ?

ORM vi·∫øt t·∫Øt c·ªßa "Object-Relational Mapping", l√† m·ªôt m√¥ h√¨nh l·∫≠p tr√¨nh ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ √°nh x·∫° d·ªØ li·ªáu gi·ªØa h·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu (Relational Database Management System - RDBMS) v√† c√°c ƒë·ªëi t∆∞·ª£ng trong c√°c ng√¥n ng·ªØ l·∫≠p tr√¨nh h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng (nh∆∞ Java, Python, C#, TypeScript, v√† nhi·ªÅu ng√¥n ng·ªØ kh√°c). M·ª•c ti√™u ch√≠nh c·ªßa ORM l√† gi√∫p ƒë∆°n gi·∫£n h√≥a vi·ªác l√†m vi·ªác v·ªõi c∆° s·ªü d·ªØ li·ªáu b·∫±ng c√°ch bi·∫øn ƒë·ªïi d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ trong c√°c b·∫£ng c∆° s·ªü d·ªØ li·ªáu th√†nh c√°c ƒë·ªëi t∆∞·ª£ng c√≥ th·ªÉ ƒë∆∞·ª£c truy c·∫≠p v√† qu·∫£n l√Ω b·∫±ng m√£ l·∫≠p tr√¨nh.

C√≥ r·∫•t nhi·ªÅu Tools ORM: Sequelize, Prisma, TypeORM ...h·ªó tr·ª£ javascript v√† TypeScript

Trong b√†i h·ªçc n√†y ch√∫ng ta l√†m quen v·ªõi [Sequelize](https://sequelize.org/docs/v6/getting-started/)


#### üåª Step 1: install

Doc: https://sequelize.org/docs/v6/getting-started/#installing

```bash
npm install --save sequelize
yarn add sequelize
```

C√†i ƒë·∫∑t Driver cho lo·∫°i DATABASE

```bash
npm install --save tedious # Microsoft SQL Server
yarn add tedious # Microsoft SQL Server
```

#### üåª Step 2: T·∫°o Models

T·∫°o m·ªôt t·ªáp user.model.js (ho·∫∑c user.model.ts n·∫øu b·∫°n ƒëang s·ª≠ d·ª•ng TypeScript) ƒë·ªÉ ƒë·ªãnh nghƒ©a User Entity (Model):

```js
const { DataTypes } = require('sequelize');
/**
 * Data Types
 * https://sequelize.org/docs/v6/core-concepts/model-basics/#data-types
 * 
 */
module.exports = (sequelize) => {
  const User = sequelize.define('User', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: DataTypes.INTEGER
      },
      firstName: {
        type: DataTypes.STRING(20),
        allowNull: false,
      },
      lastName: {
        type: DataTypes.STRING(20),
        allowNull: false,
      },
      numberPhone: {
        type: DataTypes.STRING(120),
        allowNull: false,
      },
      email: {
        type: DataTypes.STRING(50),
        allowNull: false,
      },
      address: {
        type: DataTypes.STRING(50),
        allowNull: true,
      },
      birthday: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      password: {
        type: DataTypes.STRING(255),
        allowNull: false,
      }
    },
    {
      //tableName: 'Users', //N·∫øu kh√¥ng khai b√°o th√¨ t√™n table = t√™n Model (th√™m s s·ªë nhi·ªÅu)
      timestamps: true, //https://sequelize.org/docs/v6/core-concepts/model-basics/#timestamps
    }
  );

  return User;
};

```

Xem th√™m t√†i li·ªáu:

- https://sequelize.org/docs/v6/core-concepts/model-basics/

- https://sequelize.org/docs/v6/core-concepts/model-basics/#data-types


#### üåª K·∫øt n·ªëi v·ªõi SQL Server

Trong folder src/models t·∫°o file index.js

```js
const { Sequelize } = require('sequelize');
//Import th√¥ng tin c·∫•u h√¨nh database server
const dbConfig = require('../configs/db')
const sequelize = new Sequelize(dbConfig);

const models = {};

models.Sequelize = Sequelize;
models.sequelize = sequelize;

//K·∫øt n·ªëi c√°c Models (B·∫£ng) t·∫°i ƒë√¢y
models.User = require('./user.model')(sequelize, Sequelize);
//... th√™m v√†o sau c√°c Model kh√°c

module.exports = models;

```

file db.js

B·∫°n c·∫ßn chu·∫©n b·ªã m·ªôt account x√°c th·ª±c SQL Authentication

```js
const dbConfig = {
    dialect: 'mssql',
    host: 'NHAN2',
    port: 1433,
    username: 'nhan',
    password: '123456789',
    database: 'myStore', //B·∫°n ph·∫£i t·∫°o Database tr∆∞·ªõc
    dialectOptions: {
        options: {
          encrypt: false, 
        },
    },
}

module.exports = dbConfig;
```

L∆∞u √Ω b·∫°n ph·∫£i t·∫°o Database tr∆∞·ªõc v√† kh√¥ng c·∫ßn t·∫°o b·∫£ng, K·∫øt n·ªëi th√†nh c√¥ng th√¨ code s·∫Ω t·ª± ƒë·ªông t·∫°o c√°c table d·ª±a tr√™n c√°c Models m√† b·∫°n ƒë√£ c·∫•u h√¨nh.


file server.js s·ª≠a l·∫°i nh∆∞ sau

```js
require('dotenv').config();
const app = require("./src/app");
const PORT = process.env.PORT || 9000;
const models = require('./src/models');


/**
 * T·∫°o h√†m ki·ªÉm tra db k·∫øt n·ªëi th√†nh c√¥ng ch∆∞a
 * K·∫øt n·ªëi Database server OK --> start server express
 */
const initApp = async () => {
  console.log("Testing the database connection..");

  try {
     //test k·∫øt n·ªëi
     await models.sequelize.authenticate();
     console.log("Connection has been established successfully.");

     
    // ƒê·ªìng b·ªô h√≥a c∆° s·ªü d·ªØ li·ªáu v√† kh·ªüi t·∫°o c√°c b·∫£ng n·∫øu ch∆∞a t·ªìn t·∫°i
    /**
     * sync() , t·∫°o m·ªõi n·∫øu ch∆∞a, c√≤n r·ªìi th√¨ th√¥i
     * sync({ force: true }), x√≥a c≈© t·∫°o m·ªõi l·∫°i
     * sync({ alter: true }), check v√† ƒë·ªìng b·ªô thay ƒë·ªïi
     */
    models.sequelize.sync({ alter: true }).then(() => {
      console.log('Database synced');
    }).catch((error) => {
      console.error('Error syncing database:', error);
    });

    //Kh·ªüi t·∫°o server Express
    app.listen(PORT, () => {
      console.log(`Server is running at: http://localhost:${PORT}`);
    });

    
  } catch (error) {
     console.error("Unable to connect to the database:", error.original);
  }
};

initApp();

```

Sau khi t·∫°o xong, b·∫°n th·ª≠ ch·∫°y server l√™n

```bash
yarn dev
```

Check xem trong Database server c√≥ ƒë∆∞·ª£c ƒë·ªìng b·ªô kh√¥ng, n·∫øu ch∆∞a t·∫°o tables th√¨ s·∫Ω ƒë∆∞·ª£c t·∫°o m·ªõi.

Xem v√≠ d·ª•: 02-Examples\SIMPLE-express-SQLSever-Sequelizes


## üíõ SQL Server with TypeORM library